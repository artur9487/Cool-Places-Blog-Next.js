/** @format */

import Head from 'next/head';
import React, { useEffect } from 'react';
import { Box } from '@mui/system';
import Layout from '../components/Layout';
import { Context } from '../ContextComp';
import { useState, useLayoutEffect, useRef } from 'react';
import { request, gql } from 'graphql-request';
import { useMediaQuery } from '@mui/material';

const MainLayout = (props) => {
	const { placesOutput, categoriesOutput, type, mostCommentedOutput } = props;
	const [numberToLoad, setNumberToLoad] = useState(placesOutput.length);
	const [data, setData] = useState(placesOutput);
	const firstUpdate = useRef(true);
	const maxWidth900 = useMediaQuery('(max-width:900px)');
	const maxWidth600 = useMediaQuery('(max-width:600px)');

	useLayoutEffect(() => {
		if (firstUpdate.current) {
			if (type === 'all') {
				const url =
					'https://api-eu-central-1.hygraph.com/v2/cl10szcbx0rd401z04l0ldt9g/master';
				const start = async () => {
					const query = gql`
						query PlaceQuery($numberToLoad: Int!) {
							placesSConnection(first: $numberToLoad, orderBy: createdAt_ASC) {
								edges {
									node {
										description
										id
										photo {
											url
										}
										placeName
										category
										createdAt
									}
								}
							}
						}
					`;

					const variables = { numberToLoad };

					const response = await request(url, query, variables);
					const endResult = response.placesSConnection.edges;
					setData(endResult);
				};
				start();
			}
		}
	}, [numberToLoad, type]);

	return (
		<Context.Provider
			value={{
				data,
				categoriesOutput,
				mostCommentedOutput,
				setNumberToLoad,
				type,
				maxWidth900,
				maxWidth600
			}}>
			<Box sx={{ position: 'relative' }}>
				<Layout>
					<>
						<Head>
							<title>Cool Placs Nextjs blog</title>
							<meta name='description' content='Generated by create next app' />
							<link rel='icon' href='/favicon.ico' />
						</Head>
						{props.children}
					</>
				</Layout>
			</Box>
		</Context.Provider>
	);
};

export default MainLayout;
